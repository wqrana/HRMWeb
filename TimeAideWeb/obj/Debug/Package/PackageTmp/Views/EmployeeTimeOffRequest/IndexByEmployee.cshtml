@using TimeAide.Common.Helpers;

@{
    ViewBag.Title = "Employee Time Off";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var isReadOnly = ((int)ViewBag.UserId != SessionHelper.LoginId);
}
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js" integrity="sha512-T/tUfKSV1bihCnd+MxKD0Hm1uBBroVYBOYSk1knyvQ9VyZJpc/ALb4P0r6ubwVPSGB2GvjeoMAJJImBG12TiaQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" integrity="sha512-mSYUmp1HYZDFaVKK//63EcZq4iFWFjxSL+Z3T/aCt4IO9Cejm03q3NKKYN6pFQzY0SBOr8h+eCIAZHPXcpZaNw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
@Html.Hidden("UserId", (int)ViewBag.UserId)


<!-- Page Header -->
<div class="page-header">
    <div class="row align-items-center">
        <div class="col">
            <h3 class="page-title">Employee Time Off</h3>
        </div>

        <div class="col-auto float-right ml-auto">
            @if (isReadOnly == false)
            {
                <a href="javascript:getTimeOffRequest();" class="btn add-btn"><i class="fa fa-plus"></i> Request Time Off</a>
            }
        </div>

    </div>
</div>
<!-- /Page Header -->

<div class="row">
    <div class="col-md-12">
        <div id="divLoadingTimeOffRequestList" class="align-content-md-start">
            <img src="~/Content/Themes/assets/img/ajax-loading.gif" width="18" height="18" />
        </div>
        <div id="divTimeOffRequestList">

        </div>
    </div>

</div>
<div id="divTimeOffRequest">

</div>
<div id="divTimeOffCalendar">

</div>
@*<div id="timeOffRequestDocument_modal" class="modal custom-modal">
        <div class="modal-dialog modal-dialog-centered modal-md">
            <div class="modal-content">
                <div class="mt-2 p-1">
                    <div class="alert alert-primary" style="text-align:center;background-color: #00c5fb;border: 1px solid #00c5fb;">
                        <h4 style="display: inline;">Time-Off Request Document(s)</h4>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">×</span>
                        </button>
                    </div>
                    <hr>
                </div>
                <div class="modal-body pt-0 pb-2">
                    <div id="divTimeOffRequestDocument">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="divTimeOffRequestDocumentUpADownLoad">

    </div>
*@

@Html.Partial("~/Views/EmployeeTimeOffRequestDocument/_PostSubmitRequestDocument.cshtml")
<script>
    $(document).ready(function () {

        retreiveEmployeeTimeOffRequests();
        //$('#tblTimeOff').dataTable({
        //    "searching": true,
        //    "paging": true
        //});
    });

    function getTimeOffRequest() {
        $.ajax({
            type: "GET",
            url: '/EmployeeTimeOffRequest/CreateTimeOff',
            data: { "id": $("#UserId").val() },
            success: function (data) {
                debugger;
                $("#divTimeOffRequest").html(data);
                $("#employeeTimeOffRequest_modal").modal("show");
            },
            error: function () {
            }
        });
    }
    //time-off document submission
    // function getTimeOffRequestDocument(id, openType) {
    //     $.ajax({
    //         type: "GET",
    //         url: '/EmployeeTimeOffRequestDocument/GetTimeOffRequestDocument',
    //         data: { "id": id },
    //         success: function (data) {
    //             debugger;
    //             $("#divTimeOffRequestDocument").html(data);
    //             if (openType != "Refresh") {
    //                 $("#timeOffRequestDocument_modal").modal("show");
    //             }
    //         },
    //         error: function () {
    //         }
    //     });
    // }
    // function openUploadDocumentPopup(id) {
    //     $.ajax({
    //         type: "GET",
    //         url: '/EmployeeTimeOffRequestDocument/EditUploadDocumentFiles',
    //         data: { "id": id },
    //         success: function (data) {
    //             debugger;
    //             $("#divTimeOffRequestDocumentUpADownLoad").html(data);

    //             $("#uploadTimeOffDocument_modal").modal("show");

    //         },
    //         error: function () {
    //         }
    //     });
    // }
    // function saveTimeOffDocumentFileData(dataObj) {
    //     debugger;

    //     var formData = new FormData();
    //     formData.append('model.EmployeeTimeOffDocumentId', dataObj.Id);
    //     formData.append('model.DocumentName', dataObj.DocumentName);
    //     formData.append('model.DocumentType', dataObj.DocumentType);
    //     formData.append('model.SubmissionType', dataObj.SubmissionType);
    //     formData.append('model.Status', dataObj.Status);

    //     formData.append('model.DocumentFile1Name', dataObj.DocumentFile1Name);
    //     formData.append('model.DocumentFile1', dataObj.DocumentFile1);
    //     formData.append('model.DocumentFile1Action', dataObj.DocFile1Action);

    //     formData.append('model.DocumentFile2Name', dataObj.DocumentFile2Name);
    //     formData.append('model.DocumentFile2', dataObj.DocumentFile2);
    //     formData.append('model.DocumentFile2Action', dataObj.DocFile2Action);

    //     formData.append('model.DocumentFile3Name', dataObj.DocumentFile3Name);
    //     formData.append('model.DocumentFile3', dataObj.DocumentFile3);
    //     formData.append('model.DocumentFile3Action', dataObj.DocFile3Action);

    //     if (formData != null) {
    //         $.ajax({
    //             url: "/EmployeeTimeOffRequestDocument/EditTimeOffRequestDocument",
    //             type: 'POST',
    //             dataType: "json",
    //             contentType: "multipart/form-data",
    //             data: formData,
    //             processData: false,
    //             contentType: false,
    //             success: function (result) {
    //                 debugger;
    //                 if (result.status == "Success") {
    //                     showAlertAutoHide("", result.status, result.message);
    //                     $("#uploadTimeOffDocument_modal").modal("hide");
    //                     getTimeOffRequestDocument(dataObj.RequestId, "Refresh");
    //                 }
    //                 else {
    //                     showAlertAutoHide("", result.status, result.message);
    //                 }
    //             },
    //             error: function (data) {
    //                 console.log(data.status);
    //             }
    //         });
    //     }
    // }
    // function openDownloadDocumentPopup(id) {
    //     $.ajax({
    //         type: "GET",
    //         url: '/EmployeeTimeOffRequestDocument/DownloadDocumentFiles',
    //         data: { "id": id },
    //         success: function (data) {
    //             debugger;
    //             $("#divTimeOffRequestDocumentUpADownLoad").html(data);

    //             $("#downloadTimeOffDocument_modal").modal("show");

    //         },
    //         error: function () {
    //         }
    //     });
    // }
    // function downloadDocumentFile(id, fileSeq) {
    //     debugger;
    //     window.location.href = "/EmployeeTimeOffRequestDocument/DownloadDocumentFile?id=" + id + "&fileSeq=" + fileSeq;

    // }
    //  end document submission

    function getTimeOffRequestCancellation(id) {
        $.ajax({
            type: "GET",
            url: '/EmployeeTimeOffRequest/CancelTimeOffRequest',
            data: { "id": id },
            success: function (data) {
                debugger;
                $("#divTimeOffRequest").html(data);
                $("#timeOffRequestCancel_modal").modal("show");
            },
            error: function () {
            }
        });
    }
    function getTimeOffRequestStatusHistory(timeoffRequestId) {
        debugger;
        $.ajax({
            type: "GET",
            url: '/EmployeeTimeOffRequest/GetTimeOffRequestStatusHistory',
            data: { "id": timeoffRequestId },
            success: function (data) {
                debugger;
                $("#divTimeOffRequest").html(data);
                $("#timeOffRequestStatusHistory_modal").modal("show");
            },
            error: function () {
            }
        });
    }
    function saveTimeOffRequestData() {
        //debugger;

        var dataObj = new Object();
        dataObj.UserInformationId = $('#UserInformationId').val();
        dataObj.EmployeeId = $('#EmployeeId').val();
        dataObj.TransType = $("#TimeOffTypeId option:selected").text();
        dataObj.AccrualType = $('#TimeOffTypeId').val();
        dataObj.StartDate = $('#StartDate').val();
        dataObj.EndDate = $('#EndDate').val();
        dataObj.DayHours = $('#DayHours').val();
        dataObj.WorkingDays = $('#WorkDays').val();
        dataObj.RequestNote = $('#RequestReason').val();
        var RemainingTime = $("#RemainingTime").val();

        //Fields validation
        var isRequiredValidated = 0;
        var isValidated = true;
        var message = "";

        if (dataObj != null) {
            isRequiredValidated += dataObj.AccrualType.trim().length > 0 ? 1 : 0;
            isRequiredValidated += dataObj.StartDate.trim().length > 0 ? 1 : 0;
            isRequiredValidated += dataObj.EndDate.trim().length > 0 ? 1 : 0;
            isRequiredValidated += dataObj.DayHours.trim().length > 0 ? 1 : 0;
            isRequiredValidated += dataObj.RequestNote.trim().length > 0 ? 1 : 0;
            if (isRequiredValidated != 5) {
                isValidated = false;
                message = " Missing Required field(s)";
            }
            if (!isValidated) {
                showAlertAutoHide("", 'Error', message);
                return;
            }
            if (!isNaN(RemainingTime) && RemainingTime < 0) {
                showAlertAutoHide("", 'Error', "Requested time is more than the available balance. Please see calendar.");
                return;
            }
            if (!isNaN(dataObj.WorkingDays) && dataObj.WorkingDays == 0) {
                showAlertAutoHide("", 'Error', "Time-off working day(s) should be more than zero.");
                return;
            }
        }

        if (isValidated) {
            // ajax call for saving data
            $("#divRefreshingDetail").show();
            disabledSubmitAction(true);
            $.ajax({
                type: "POST",
                url: "/EmployeeTimeOffRequest/SaveTimeOffRequest",
                data: JSON.stringify(dataObj),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (data) {
                    debugger;
                    if (data.status == "Success") {
                        $("#divRefreshingDetail").hide();
                        $("#employeeTimeOffRequest_modal").modal("hide");
                        showAlertAutoHide("", data.status, data.message);
                        if (data.requestId > 0) {
                            saveTimeOffRequestDocuments(data.requestId)
                        }
                        retreiveEmployeeTimeOffRequests();
                        // location.reload(true);
                    }
                    else {
                        disabledSubmitAction(false);
                        showAlertAutoHide("", data.status, data.message);
                        $("#divRefreshingDetail").hide();
                    }

                }
                ,
                error: function (request, status, error) {
                    disabledSubmitAction(false);
                    showAlertAutoHide("", "Error", error);
                    return false;
                }
            });
        }
    }
    function retreiveEmployeeTimeOffRequests() {
        $("#divLoadingTimeOffRequestList").show();
        $.ajax({
            type: "GET",
            url: '/EmployeeTimeOffRequest/GetEmployeeTimeOffRequestList',
            data: { "id": $("#UserId").val() },
            success: function (data) {
                debugger;
                $("#divTimeOffRequestList").html(data);
                $("#divLoadingTimeOffRequestList").hide();
            },
            error: function () {
            }
        });
    }
</script>
