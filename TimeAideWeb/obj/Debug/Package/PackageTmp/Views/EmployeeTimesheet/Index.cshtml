
@{
    ViewBag.Title = "Timesheet";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@*<link href="https://unpkg.com/gijgo@1.9.13/css/gijgo.min.css" rel="stylesheet" type="text/css" />*@
<!-- Page Header -->
<style>
    .showSection {
        display: block;
    }

    .hideSection {
        display: none;
    }
</style>
@{
    var isEmpReview = (new TimeAide.Services.ApplicationConfigurationService()).EmployeeTimeSheetApproval;
    var isSupvApproval = (new TimeAide.Services.ApplicationConfigurationService()).SupervisorTimeSheetApproval;
    var showhideEmpRvwFilter = isEmpReview == 1 ? "showSection" : "hideSection";
    var showhideSuprAprFilter = isSupvApproval == 1 ? "showSection" : "hideSection";
}
<div class="page-header">
    <div class="row align-items-center">
        <div class="col-sm-12">
            <h3 class="page-title">Timesheet</h3>
            <ul class="breadcrumb">
                <li class="breadcrumb-item">Attendance</li>
                <li class="breadcrumb-item active">Timesheet</li>

            </ul>
            <div class="alert" style="display:none;" id="applicantIndexPageAlert">
                <a href="javascript:void(0)" class="close" id="alertDismiss">&times;</a>
                <strong>Alert!</strong><span></span>
            </div>
        </div>

    </div>
</div>
<div class="row filter-row pl-2">
    <div class="col-sm-2 col-md-2 pr-0 pl-0">
        <div class="form-group form-focus mb-2">
            <input id="txtDTStartDate" type="datetime" class="form-control floating" value="@DateTime.Today">
            <label class="focus-label">From Date</label>
        </div>
    </div>
    <div class="col-sm-2 col-md-2 pr-0 pl-0">
        <div class="form-group form-focus mb-2">
            <input id="txtDTEndDate" type="datetime" class="form-control floating" value="@DateTime.Today">
            <label class="focus-label">To Date</label>
        </div>
    </div>

    <div class="col-sm-2 col-md-2 pr-0 pl-0">
        <div class="form-group form-focus mb-2">
            <input id="EmployeeId" type="text" class="form-control floating">
            <label class="focus-label">Employee ID</label>
        </div>
    </div>
    <div class="col-sm-6 col-md-3 pl-0 pr-0">
        <div class="form-group form-focus mb-2">
            <input id="EmployeeName" type="text" class="form-control floating">
            <label class="focus-label">Employee Name</label>
        </div>
    </div>
    <div class="col-sm-2 col-md-2 pl-0 pr-0">
        <div class="form-group form-focus select-focus mb-2">
            @Html.DropDownList("DepartmentId", null, "All", new { @class = "select floating" })
            <label class="focus-label">Department</label>
        </div>
    </div>
    <div class="col-sm-2 col-md-2 pl-0 pr-0">
        <div class="form-group form-focus select-focus">
            @Html.DropDownList("SubDepartmentId", null, "All", new { @class = "select floating" })
            <label class="focus-label">SubDepartment</label>
        </div>
    </div>
    <div class="col-sm-2 col-md-2 pl-0 pr-0">
        <div class="form-group form-focus select-focus">
            @Html.DropDownList("EmployeeTypeId", null, "All", new { @class = "select floating" })
            <label class="focus-label">Employee Type</label>
        </div>
    </div>

    <div class="col-sm-2 col-md-2 pl-0 pr-0 @showhideEmpRvwFilter">
        <div class="form-group form-focus select-focus">
            <select class="select floating" id="intUserReviewedId">
                <option value="-1">All</option>
                <option value="0">Unreviewed</option>
                <option value="1">Reviewed</option>
            </select>
            <label class="focus-label">Employee Review</label>
        </div>
    </div>
    <div class="col-sm-2 col-md-2 pl-0 pr-0 @showhideSuprAprFilter">
        <div class="form-group form-focus select-focus">
            <select class="select floating" id="nReviewStatusId">
                <option value="-1">All</option>
                <option value="0">Unapproved</option>
                <option value="2">Approved</option>
            </select>
            <label class="focus-label">Supervisor Approval</label>
        </div>
    </div>
    <div class="col-sm-2 col-md-2 pl-0 pr-0">
        <div class="form-group form-focus select-focus">
            @Html.DropDownList("ReportTypeId", null, null, new { id = "ddlReportType", @class = "select floating" })
            <label class="focus-label">Report Type</label>
        </div>
    </div>
    <div class="col-sm-1 col-md-1 pl-0 pr-0">
        <a href="javascript: getEmployeeTimesheet();" class="btn btn-success btn-block"> Select </a>

    </div>
</div>
<hr class="m-0" />
<!--<div class="row filter-row">
    <div class="col-sm-2 col-md-2 pl-0 pr-0">
        <div class="form-group form-focus select-focus">
            @Html.DropDownList("DepartmentId", null, "All", new { @class = "select floating" })
            <label class="focus-label">Department</label>
        </div>
    </div>
    <div class="col-sm-2 col-md-2 pl-0 pr-0">
        <div class="form-group form-focus select-focus">
            @Html.DropDownList("SubDepartmentId", null, "All", new { @class = "select floating" })
            <label class="focus-label">SubDepartment</label>
        </div>
    </div>
    <div class="col-sm-2 col-md-2 pl-0 pr-0">
        <div class="form-group form-focus select-focus">
            @Html.DropDownList("EmployeeTypeId", null, "All", new { @class = "select floating" })
            <label class="focus-label">Employee Type</label>
        </div>
    </div>
    <div class="col-sm-2 col-md-2 pl-0 pr-0">
        <div class="form-group form-focus select-focus">
            @Html.DropDownList("ReportTypeId", null, null, new { id = "ddlReportType", @class = "select floating" })
            <label class="focus-label">Report Type</label>
        </div>
    </div>
    <div class="col-sm-1 col-md-1 pl-0 pr-0">-->
@*@if (ViewBag.HasCompanyId)
    {*@
<!--<a href="javascript: getEmployeeTimesheet();" class="btn btn-success btn-block"> Select </a>-->
@*}
    else
    {
        <div class="alert-danger"> Unauthorized Access</div>
    }*@
<!--</div>
</div>-->
<div class="row pb-0 mb-0">
    <div class="col-sm-10">
    </div>
    <div class="col-sm-2 pr-0">
        <div class="col-auto float-right ml-auto pr-0">
            <div class="btn-group btn-group-sm pb-1">
                @if (ViewBag.HasCompanyId)
                {
                    <button class="btn btn-white" onclick="javascript:runLocalReport(0)"><i class="fa fa-print fa-lg"></i> Print</button>
                }
            </div>
        </div>
    </div>
</div>
<div style="padding:1px; padding-top:0px;">
    <div style="font-size: 90%;">
        <div class="form-group row mb-0">
            <div id="divLoadingTimeSheetReportWeekList" class="align-content-md-center">
                <img src="~/Content/Themes/assets/img/ajax-loading.gif" width="24" height="24" />
            </div>
            <div class="panel panel-default" style="width:100%;margin-left:5px">
                <div class="panel-heading" style="padding-left:10px">
                    Timesheet
                    @*<div class="pull-right dropdown-action" style="height:20px;" id="contactInfoMenu">
                        <a href="#" class="action-icon dropdown-toggle" data-toggle="dropdown" aria-expanded="false"><i class="material-icons">more_horiz</i></a>
                        <div class="dropdown-menu dropdown-menu-right" x-placement="bottom-end" style="position: absolute; will-change: transform; top: 0px; left: 0px; transform: translate3d(38px, 32px, 0px);">
                            <a a href="javascript:AddEditContactInfo();" class="dropdown-item"><i class="fa fa-pencil m-r-5"> Edit</i></a>
                        </div>
                    </div>*@
                </div>
                <div class="panel-body">
                    <div id="divReportWeekList" style="max-height:450px; overflow-y:auto">
                        Fetch Timesheet
                    </div>
                </div>
            </div>
        </div>
        <div class="form-group row mb-0">
            <div class="col-8" style="padding-left:0px">
                <div id="divLoadingTimeSheetDetail" class="align-content-md-center">
                    <img src="~/Content/Themes/assets/img/ajax-loading.gif" width="24" height="24" />
                </div>
                <div class="panel panel-default" style="width:100%;margin-left:5px">
                    <div class="panel-heading" style="padding-left:10px">
                        Timesheet Detail
                    </div>
                    <div class="panel-body">
                        <div id="divTimeSheetDetail">
                            No Timesheet Selected for selected week
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-4" style="padding-left:0px">
                <div id="divLoadingDailyCompensation" class="align-content-md-center">
                    <img src="~/Content/Themes/assets/img/ajax-loading.gif" width="24" height="24" />
                </div>
                <div class="panel panel-default" style="width:100%;margin-left:5px">
                    <div class="panel-heading" style="padding-left:10px">
                        Daily Compensation
                    </div>
                    <div class="panel-body">
                        <div id="divDailyCompensation">
                            No Daily Compensation for selected date
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    var alertID = null;
    $(document).ready(function () {
        debugger;
        $("#divLoadingTimeSheetReportWeekList").hide();
        $("#divLoadingTimeSheetDetail").hide();
        $("#divLoadingDailyCompensation").hide();
        $('#pickDateTime').datetimepicker({
            format: "DD/MM/YYYY hh:mm A"
        });
        $('#DepartmentId').change(function (e) {
            debugger;
            var departmentId = $(this).val();
            LoadSubDepartmentDropdown(departmentId, '#SubDepartmentId', null);
        })
    });

    function LoadSubDepartmentDropdown(departmentId, targetElement, selectedValue) {

        $.ajax({
            url: '/SubDepartment/SupervisorSubDepartmentByDepartment',
            data: { 'departmentId': departmentId }, //dataString,
            dataType: 'json',
            type: 'GET',
            success: function (res) {
                debugger;
                var data = res;
                $(targetElement + ' option').remove();
                var option = '<option value=""> All </option>';
                $(targetElement).append(option);
                $(data).each(function () {
                    var option = '<option value=' + this.id + '>' + this.name + '</option>';
                    $(targetElement).append(option);
                });
                // if (selectedValue != null)
                $(targetElement).val(selectedValue == null ? "" : selectedValue);
            },
            error: function (xhr, status, error) {
                //displayErrorMessage('Error during retrieving Data:' + error);
            }
        });

    }
    function getEmployeeTimesheet() {
        
        debugger;
        var filterObject = new Object();
        filterObject.DTStartDate = $('#txtDTStartDate').val();
        filterObject.DTEndDate = $('#txtDTEndDate').val();
        filterObject.e_id = $('#EmployeeId').val();
        filterObject.e_name = $('#EmployeeName').val();
        filterObject.nDept = $('#DepartmentId').val();
        filterObject.nJobTitleID = $('#SubDepartmentId').val();
        filterObject.nEmployeeType = $('#EmployeeTypeId').val();
        filterObject.intUserReviewed = $('#intUserReviewedId').val();
        filterObject.nReviewStatus = $('#nReviewStatusId').val();

        var sDate = new Date(moment(filterObject.DTStartDate).format("YYYY-MM-DD"));
        var eDate = new Date(moment(filterObject.DTEndDate).format("YYYY-MM-DD"));
        if (eDate < sDate) {
            showAlertAutoHide("", "Error", "To Date should be greater or equal to From Date.");
            return;
        }
        $("#divLoadingTimeSheetReportWeekList").show();
        $.ajax({
            type: "POST",
            url: '/EmployeeTimesheet/ReportWeekList',
            data: JSON.stringify(filterObject),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                $("#divReportWeekList").html(data);
                $("#divTimeSheetDetail").text("No Report Week Selected");
                $("#divLoadingTimeSheetReportWeekList").hide();
            },
            error: function () {
            }
        });
    }
    function getTimeSheetDetail(nWeekID) {
        $("#divLoadingTimeSheetDetail").show();
        debugger;

        $.ajax({
            type: "GET",
            url: '/EmployeeTimeSheet/TimesheetDetail',
            data: { "nWeekID": nWeekID },
            success: function (data) {
                debugger;
                $("#divTimeSheetDetail").html(data);
                $("#divLoadingTimeSheetDetail").hide();
                $('html, body').animate({
                    scrollTop: ($('#divTimeSheetDetail').offset().top)
                }, 500);
            },
            error: function () {
            }
        });
    }

    function getDailyCompensation(e_id, DTPunchDate) {
        $("#divLoadingDailyCompensation").show();
        debugger;

        $.ajax({
            type: "GET",
            url: '/EmployeeTimeSheet/DailyCompensation',
            data: { "e_id": e_id, "DTPunchDate": DTPunchDate },
            success: function (data) {
                debugger;
                $("#divDailyCompensation").html(data);
                $("#divLoadingDailyCompensation").hide();
                $('html, body').animate({
                    scrollTop: ($('#divDailyCompensation').offset().top)
                }, 500);
            },
            error: function () {
            }
        });
    }

    function runLocalReport(tpwId) {
        debugger;
        var dataObj = new Object();
        dataObj.ReportId = 29; // give report id
        dataObj.CriteriaType = 2; // 2 is used to run local report
        dataObj.AttendanceSchId = tpwId;
        //dataObj.ScheduleDate = $('#ScheduleDate').val();
        dataObj.EmployeeSelectionIds = tpwId == 0 ? $('#SelectedReportWeekIds').val() : tpwId;
        $.ajax({
            type: "POST",
            url: "/Reports/AdhocReportPopup",
            data: JSON.stringify(dataObj),
            contentType: "application/json; charset=utf-8",
            // dataType: "json",
            success: function (data) {
                debugger;
                //console.log(data);
                $("#divAdhocReportPopup").html(data);
                // setTimeout(function () { $('#divLoadingReport').hide(); }, 3000);
                $("#AdhocReportPopup_modal").modal('show');
            },
            error: function (request, status, error) {
                alert('Error in in runing  report data');
                return false;
            }
        });
    }
</script>
