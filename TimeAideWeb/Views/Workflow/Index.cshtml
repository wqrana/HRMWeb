@model IEnumerable<TimeAide.Web.Models.Workflow>
@{
    ViewBag.Title = "Workflow";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="page-header">
    <div class="row align-items-center">
        <div class="col-sm-12">
            <h3 class="page-title">Workflow</h3>
            <ul class="breadcrumb">
                <li class="breadcrumb-item">Master Data</li>
                <li class="breadcrumb-item active">Workflow</li>
            </ul>
            <div class="alert" style="display:none;" id="IndexPageAlert">
                <a href="javascript:void(0)" class="close" id="alertDismiss">&times;</a>
                <strong>Alert!</strong><span></span>
            </div>
        </div>
    </div>
</div>
<div style="padding:0px">
    <div style="font-size: 90%;">
        <div class="form-group row mb-0">
            <div class="col-md-12 p-0">
                <!-- <div class="panel panel-default" style="width:49%;margin-left:10px">-->
                <div class="panel panel-default" style="margin-left:5px">
                    <div class="panel-heading" style="padding-left:10px">
                        Workflow List
                        <div class="pull-right dropdown-action" style="height:20px;">
                            <a href="#" title="Action Menu" class="action-icon dropdown-toggle" data-toggle="dropdown" aria-expanded="false"><i class="material-icons">more_horiz</i></a>
                            <div class="dropdown-menu dropdown-menu-right" x-placement="bottom-end" style="position: absolute; will-change: transform; top: 0px; left: 0px; transform: translate3d(25px, 20px, 0px);">
                                <a href="javascript:createEditWorkflow(0);" class="dropdown-item"><i class="fa fa-plus m-r-5"></i> Add</a>
                            </div>
                        </div>
                    </div>
                    <div class="panel-body">
                        <div  style="max-height:255px; overflow-y:auto">
                            <div class="table-responsive">
                                <table class="table table-striped custom-table table-nowrap mb-0" id="tblWorkflow"> 
                                    <tr>
                                        <th>
                                            Show Detail
                                        </th>
                                        <th>
                                            @Html.DisplayNameFor(model => model.WorkflowName)
                                        </th>
                                        <th>
                                            @Html.DisplayNameFor(model => model.WorkflowDescription)
                                        </th>
                                        <th>
                                            @Html.DisplayNameFor(model => model.NumberOfLevels)
                                        </th>
                                        <th>
                                            Closing Notification
                                        </th>
                                        <th>
                                            @Html.DisplayNameFor(model => model.IsAllCompanies)
                                        </th>
                                        <th></th>
                                    </tr>

                                    @foreach (var item in Model)
                                    {
                                <tr>
                                    <td>
                                        <a href="javascript:getWorkflowLevel(@item.Id);"><span class="fa fa-eye"></span></a>
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.WorkflowName)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.WorkflowDescription)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.NumberOfLevels)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.ClosingNotification.ClosingNotificationTypeName)
                                    </td>
                                    <td>
                                        @Html.DisplayFor(modelItem => item.IsAllCompanies)
                                    </td>
                                    <td width="10%">
                                        <div class="pull-right dropdown-action">
                                            <a href="#" class="action-icon dropdown-toggle" data-toggle="dropdown" aria-expanded="false"><i class="material-icons">more_horiz</i></a>
                                            <div class="dropdown-menu dropdown-menu-right" x-placement="bottom-end" style="position: absolute; will-change: transform; top: 0px; left: 0px; transform: translate3d(25px, 20px, 0px);">

                                                <a href="javascript:createEditWorkflow(@item.Id);" class="dropdown-item" data-id="@item.Id"><i class="fa fa-pencil m-r-5"></i> Edit</a>
                                                @*<a href="javascript:getWorkflowItemDetail(@item.Id);" class="dropdown-item"><i class="fa fa-eye m-r-5"></i> Details</a>*@
                                                <a href="javascript:getWorkflowDeleteData(@item.Id);" class="dropdown-item"><i class="fa fa-trash m-r-5"></i> Delete</a>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                    }

                                </table>
                            </div>
                          </div>
                        </div>

                    </div>
            </div>
            
        </div>
        <div class="form-group row">
            <div class="col-md-12 p-0">
                <div id="divWorkflowLevel">

                </div>
            </div>
        </div>
    </div>
    </div>
<div id="divCreateEditDelPopUp">

</div>
<script>
    $(document).ready(function () {
        getWorkflowLevel(null);

    });
    function getWorkflowLevel(workflowId) {
        debugger;
        $.ajax({
            type: "get",
            url: '/WorkflowLevel/IndexByWorkflow',
            data: { "id": workflowId },

            success: function (data) {
                // debugger;
                //console.log(data);
                $("#divWorkflowLevel").html(data);
                //$("#WorkflowCreateEdit_modal").modal("show");

            },
            error: function () {
                alert(data.ErrorMessage);
            }
        });
    }
    function createEditWorkflow(workflowId) {
        debugger;
        var ActionMethod = workflowId == 0 ? "Create" : "Edit";
        $.ajax({
            type: "get",
            url: '/Workflow/' + ActionMethod,
            data: { "id": workflowId },

            success: function (data) {
                // debugger;
                //console.log(data);
                $("#divCreateEditDelPopUp").html(data);
                $("#WorkflowCreateEdit_modal").modal("show");
                //$('#myModalContent').html(data);
                //$('#myModal').modal('show');

            },
            error: function (request, status, error) {
                debugger
                showAlertAutoHide(alertID, "Error", error);
                return false;
            }
        });

    }
    function saveWorkflowData() {
        debugger;
        var alertID = "#WorkflowCreateEditAlert";
        var isRequiredValidated = 0;
        var isValidated = true;
        var message = "";
        var dataObj = new Object();
        dataObj.id = $('#WorkflowId').val();
        dataObj.CreatedDate = $('#CreatedDate').val();
        dataObj.CreatedBy = $('#CreatedBy').val();
        dataObj.DataEntryStatus = $('#DataEntryStatus').val();

        dataObj.WorkflowName = $('#WorkflowName').val();
        dataObj.WorkflowDescription = $('#WorkflowDescription').val();
        dataObj.ClosingNotificationId = $('#ClosingNotificationId').val();
        dataObj.ClosingNotificationMessageId = $('#ClosingNotificationMessageId').val();
        dataObj.ReminderNotificationMessageId = $('#ReminderNotificationMessageId').val();
        dataObj.CancelNotificationMessageId = $('#CancelNotificationMessageId').val();
        dataObj.IsZeroLevel = $('#IsZeroLevel').is(":checked");
        if ($('#chkAllCompanies').is(":checked")) { 
            dataObj['CompanyId'] = '';
        }
        else {
            dataObj['CompanyId'] = $('#hdnSelectedCompanyId').val();
        }
        if (dataObj != null) {
            isRequiredValidated += dataObj.WorkflowName.trim().length > 0 ? 1 : 0;
            isRequiredValidated += dataObj.ClosingNotificationMessageId.trim().length > 0 ? 1 : 0;
            if (isRequiredValidated != 2) {
                isValidated = false;
                message = " Missing Required field(s)";
            }
        }
        if (!isValidated) showAlertAutoHide(alertID, 'Error', message);

        if (isValidated) {
            // ajax call for saving data
            $.ajax({
                type: "POST",
                url: "/Workflow/CreateEdit",
                data: JSON.stringify(dataObj),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (data) {
                    //debugger;
                    if (data.status == "Success") {
                        $("#WorkflowCreateEdit_modal").modal("hide");
                        showAlertAutoHide("#IndexPageAlert", data.status, data.message);
                        location.reload(true);
                    }
                    else {
                        showAlertAutoHide(alertID, data.status, data.message);
                    }
                }
                ,
                error: function (request, status, error) {
                    alert('Error in deleting parent alert data');
                    return false;
                }
            });
        }
    }
    function getWorkflowDeleteData(workflowId) {
        if (workflowId != '') {

            $.ajax({
                type: "get",
                url: '/Workflow/Delete',
                data: { "id": workflowId },

                success: function (data) {
                    //debugger;
                    //$("#divCreateEditDelPopUp").html(data);
                    //$("#WorkflowCreateEdit_modal").modal("show");
                    $('#myModalContent').html(data);
                    $('#myModal').modal('show');
                },
                error: function () {
                    // displayWarningMessage(data.ErrorMessage);
                }
            });
        }
    }
    function deleteWorkflow(workflowId) {
        debugger;
        alertID = "#WorkflowDeleteAlert"
        if (workflowId != '') {
            $.ajax({
                type: "Post",
                url: "/Workflow/ConfirmDelete",
                data: { "id": workflowId },
                dataType: "json",
                success: function (data) {
                    //debugger;
                    if (data.status == "Success") {
                        $("#WorkflowDelete_modal").modal("hide");
                        showAlertAutoHide("#IndexPageAlert", data.status, data.message);
                        location.reload(true);
                    }
                    else {
                        showAlertAutoHide(alertID, data.status, data.message);
                    }
                }
                ,
                error: function (request, status, error) {
                    showAlertAutoHide(alertID, "Error", error);
                    return false;
                }
            });
        }
    }

    function getWorkflowItemDetail(workflowId) {
        if (workflowId != '') {

            $.ajax({
                type: "get",
                url: '/Workflow/Details',
                data: { "id": workflowId },

                success: function (data) {
                    //debugger;
                    $("#divCreateEditDelPopUp").html(data);
                    $("#WorkflowCreateEdit_modal").modal("show");

                },
                error: function () {
                    // displayWarningMessage(data.ErrorMessage);
                }
            });
        }
    }
</script>