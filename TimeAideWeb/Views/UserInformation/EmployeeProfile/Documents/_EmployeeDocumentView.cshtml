@using TimeAide.Common.Helpers;
@using TimeAide.Services.Helpers;
@model TimeAide.Web.Models.UserInformation
<div class="card-body">
    <div class="row">
        <div class="col-8">
            <h3 class="card-title">
                Documents
            </h3>
        </div>
        <div class="col-4">
            @if (!SecurityHelper.IsSuperAdmin && SessionHelper.LoginId == Model.Id && ViewBag.EmployeeDocumentPrivilege.AllowView)
            {
                <a href="javascript:;" onclick="fnUploadDocument(null);" class="dropdown-item"><i class="fa fa-upload m-r-5"></i> Upload New Doc</a>
            }
        </div>
    </div>
    <div class="table-responsive">
        <table class="table table-striped compact table-nowrap mb-0" id="tblSelfServiceDocuments">
            <thead>
                <tr>
                    <th>
                        Document Name
                    </th>
                    <th>
                        Document Note
                    </th>
                    <th>
                        Expiration Date
                    </th>
                    <th>
                        Is Expired
                    </th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.EmployeeDocument.Where(e => e.Document.SelfServiceDisplay))
                {
                    <tr>
                        <td>
                            @if (item.Document != null)
                            {
                                <span>
                                    @Html.DisplayFor(modelItem => item.Document.DocumentName)
                                </span>
                            }
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.DocumentNote)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.ExpirationDate)
                        </td>
                        @if (item.IsExpired)
                        {
                            <td>
                                Yes
                            </td>
                        }
                        else
                        {
                            <td>
                                No
                            </td>
                        }
                        <td>
                            <div class="dropdown dropdown-action">
                                <a href="#" class="action-icon dropdown-toggle" data-toggle="dropdown" aria-expanded="false"><i class="material-icons">more_vert</i></a>
                                <div class="dropdown-menu dropdown-menu-right" x-placement="bottom-end" style="position: absolute; will-change: transform; top: 0px; left: 0px; transform: translate3d(38px, 32px, 0px);">
                                   
                                    @if (item.IsExpired && ViewBag.EmployeeDocumentPrivilege.AllowView && item.Document.SelfServiceUpload)
                                    {
                                        if (item.SelfServiceEmployeeDocument.Where(c => c.ChangeRequestStatusId == 1).Count() > 0)
                                        {
                                            @*<a href="javascript:;" class="dropdown-item">Request already pending</a>*@
                                            <a a href="javascript:void(0);" data-toggle="modal" class="dropdown-item"><i class="fa fa-pencil m-r-5"></i> Request already pending</a>

                                        }
                                        else
                                        {
                                            <a href="javascript:;" onclick="fnUploadDocument(@item.Id);" class="dropdown-item"><i class="fa fa-upload m-r-5"></i> Upload Doc</a>
                                        }
                                    }
                                    else
                                    {
                                        <a href="javascript:downloadDocument(@item.Id)" class="dropdown-item"><i class="fa fa-download m-r-5"></i> Download Document</a>
                                    }
                                    <a href="javascript:getEmployeeDocumentUploadHistory(@item.Id)" class="dropdown-item"><i class="fa fa-file m-r-5"></i> Upload History</a>
                                </div>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

</div>
<div id="divDocumentUpoadHistory">

</div>
@*@{Html.RenderPartial("EmployeeProfile/Documents/FileUpload", Model); }*@
<html lang="en" class="no-js">
<body>
    <div id="drag_Documentfiles" class="modal custom-modal fade" role="dialog">
        <div class="modal-dialog modal-dialog-centered modal-md" role="document">
            <div class="modal-content">
                <div class="modal-header" style="padding:0px;display:block">
                    <div class="alert alert-primary" style="text-align:center;background-color: #00c5fb;border: 1px solid #00c5fb;">
                        <h5 class="modal-title">Upload New Document</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                </div>
                <div class="modal-body">
                    <div id="divDocumentFileUploadModelContent">

                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
<script type="text/javascript">
    function getUserEmployeeDocView(educationId) {
        //debugger;
        //var id = educationId == null ? $("#EmployeeEducationDetailId").val() : educationId;
        //if (id != 0) {

        //    $.ajax({
        //        type: "get",
        //        url: '/EmployeeDocument/UploadDocument',
        //        data: { "id": id },

        //        success: function (data) {
        //            $('#myModalContent').html(data);
        //            $('#myModal').modal('show');

        //        },
        //        error: function () {
        //        }
        //    });
        //}
        //else {
        //    showAlertAutoHide("#userDetailAlert", "Error", "Record doesn't exists!");
        //}
    }
    //$('#drag_files').on('shown.bs.modal', function (event) {
    //    debugger
    //    //alert('Model opening');
    //    var button = $(event.relatedTarget) //Button that triggered the modal
    //    var employeeDocumentId = button.data('id')
    //    $(".modal-body #hdnEmployeeDocumentId").val(employeeDocumentId);
    //})
    function fnUploadDocument(id) {
        var options = { "backdrop": "static", keyboard: true };
        debugger
        $.ajax({
            type: "GET",
            url: '/EmployeeSelfService/UploadDocument',
            contentType: "application/json; charset=utf-8",
            data: { "Id": id },
            datatype: "json",
            success: function (data) {
                debugger
                $('#divDocumentFileUploadModelContent').html(data);
                $('#drag_Documentfiles').modal(options);
                $('#drag_Documentfiles').modal('show');
                //toastr.success('Document submitted for approval.', "Success!");
            },
            error: function (xhr, ajaxOptions, thrownError) {
                debugger
                alert(xhr.status);
                alert("Dynamic content load failed.");
            }
        });
    }

    function downloadDocument(id) {
        debugger;
        //var id = $('#userID').val();
        $.ajax({
            url: "/EmployeeDocument/AjaxCheckDocument",
            type: "POST",
            data: {
                "userID": id
            },
            dataType: "json",
            success: function (data) {
                debugger;
                if (data.status == "Success") {
                    //$("#processing-spinner").hide();
                    window.location.href = "/EmployeeDocument/DownloadDocument/" + id;
                }
                else {
                    showAlertAutoHide('#userDetailAlert', data.status, data.message);
                }
            }
            ,
            error: function (data) {
                showAlertDismissable("#userDetailAlert", "Error", data);

            }
        });

    }
    function getEmployeeDocumentUploadHistory(employeeDocumentId) {
        debugger;
        $.ajax({
            type: "GET",
            url: '/EmployeeDocument/EmployeeDocumentUploadHistory',
            data: { "id": employeeDocumentId, "documentId": 0 },
            success: function (data) {
                debugger;
                $("#divDocumentUpoadHistory").html(data);
                $("#DocumentUpoadHistory_modal").modal("show");
            },
            error: function () {
            }
        });
    }
</script>
