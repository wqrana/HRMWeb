@model IEnumerable<TimeAide.Data.tPunchDate>
@{
    var firstModelRecord = Model.FirstOrDefault();
    var selectedTSDIds = ViewBag.selectedIds;
    var openType = ViewBag.openType;
}
<style>
    .showField {
        display: block;
    }

    .hideField {
        display: none;
    }
    .ui-timepicker-container {
        z-index: 3500 !important;
    }
    .child-modal-punch {
        z-index: 1200;
    }

    .default-width {
        min-width: 150px;
    }
</style>

<div id="timesheetAddPunches_modal" class="modal custom-modal child-modal-punch">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Punch(es)</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="welcome-box mb-2">
                                <div class="welcome-det">
                                    <h4>@Html.DisplayFor(m => firstModelRecord.e_name)</h4>
                                    <p><span class="">EmployeeId:</span>@Html.DisplayFor(m => firstModelRecord.e_id)</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">

                        <div class="col-md-3 p-0">
                            <div class="panel panel-default" style="margin-left:5px">
                                <div class="panel-heading" style="padding-left:10px">
                                    Punch Date(s)
                                </div>
                                <div class="panel-body">

                                    <div id="divPunchDates">
                                        <div id="" style="max-height:250px; overflow-y:auto">
                                            <div class="table-responsive">
                                                <table class="table table-striped custom-table table-nowrap mb-0">
                                                    <thead>
                                                        <tr>
                                                            <th>Date </th>

                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @foreach (var item in Model)
                                                        {
                                                            <tr>
                                                                <td>@Html.DisplayFor(m => item.DTPunchDate)</td>

                                                            </tr>
                                                        }
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="" class="col-md-9 pl-2">
                            <div class="row">
                                <div class="col-md-12 d-flex">
                                    <div class="card profile-box flex-fill mb-0">
                                        <div class="card-body pt-1 pb-1">

                                            <div class="row">
                                                <div class="col-md-12">
                                                    <div class="form-group row">
                                                        <label class="col-md-3 col-form-label pr-0">Punch Count: <span class="text-danger">*</span></label>
                                                        <div class="col-md-3 pr-0">
                                                            <select class="form-control" id="PunchCount">
                                                                <option value="1">1</option>
                                                                <option value="2">2</option>
                                                                <option value="4">4</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="form-group row mb-1">
                                                        <label class="col-md-2 col-form-label pr-0">Overnight <span class="text-danger"></span></label>
                                                        <label class="col-md-3 col-form-label pl-0">Punch In <span class="text-danger"></span></label>
                                                        <label class="col-md-2 col-form-label pr-0">Overnight <span class="text-danger"></span></label>
                                                        <label class="col-md-3 col-form-label pl-0">Punch Out <span class="text-danger"></span></label>
                                                        
                                                        <label class="col-md-2 col-form-label">Hr(s) <span class="text-danger"></span></label>
                                                    </div>
                                                    <div class="form-group row mb-1">
                                                        <div class="col-md-1 offset-md-1">
                                                            <div class="divPunchIn1ONight">
                                                                <input class="" type="checkbox" id="PunchIn1Overnight" />
                                                            </div>
                                                        </div>
                                                        <div class="col-md-3 pl-0 pr-0">
                                                            <input class="form-control" type="text" id="PunchIn1" />
                                                        </div>
                                                        <div class="col-md-1 offset-md-1">
                                                            <div class="divPunchOut1">
                                                                <input class="" type="checkbox" id="PunchOut1Overnight" />
                                                            </div>
                                                        </div>
                                                        <div class="col-md-3 pl-0 pr-0">
                                                            <div class="divPunchOut1">
                                                                <input class="form-control" type="text" id="PunchOut1" />
                                                            </div>
                                                        </div>

                                                        <div class="col-md-2">
                                                            <div class="divPunchOut1">
                                                                <input class="form-control" type="text" id="PunchInOut1Hrs" disabled />
                                                            </div>
                                                        </div>

                                                    </div>
                                                    <div class="divPunchInOut2">
                                                        <div class="form-group row">
                                                            <div class="col-md-1 offset-md-1">
                                                                <input class="" type="checkbox" id="PunchIn2Overnight" />
                                                            </div>
                                                            <div class="col-md-3 pl-0 pr-0">
                                                                <input class="form-control" type="text" id="PunchIn2" />
                                                            </div>
                                                            <div class="col-md-1 offset-md-1">
                                                                <input class="" type="checkbox" id="PunchOut2Overnight" />
                                                            </div>
                                                            <div class="col-md-3 pl-0 pr-0">
                                                                <input class="form-control" type="text" id="PunchOut2" />
                                                            </div>
                                                            <div class="col-md-2">
                                                                <input class="form-control" type="text" id="PunchInOut2Hrs" disabled />
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="form-group row pt-2">
                                                        <label class="col-md-2 col-form-label">Note: <span class="text-danger"></span></label>
                                                        <div class="col-md-10 pl-0">
                                                            <textarea rows="2" class="form-control" id="PunchNote"></textarea>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="submit-section mt-2">
                        <div id="" class="align-content-md-start submit-in-processing" style="display:none;">
                            <img src="~/Content/Themes/assets/img/ajax-loading.gif" width="18" height="18" />
                        </div>
                        <button id="btnSavePunches" class="btn btn-primary submit-btn btn-sm">Submit</button>
                        <button id="btnCancel" class="btn btn-primary  submit-btn btn-sm" data-dismiss="modal" aria-label="Close">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>

    $(document).ready(function () {
        setFieldLayout("1");
        $("#PunchCount").on("change", function () {
            debugger;
            resetFields();
            setFieldLayout($(this).val());
        });
        $('#PunchIn2Overnight,#PunchOut1Overnight,#PunchOut2Overnight').click(function () {
            var id = $(this).attr("id");
            var isChecked = $(this).is(":checked");
            setEnDisableOvernight(id, isChecked);
            computePunchesTime();
        });
        $('#PunchIn1,#PunchIn2,#PunchOut1,#PunchOut2').timepicker({
            timeFormat: 'hh:mm p',
            interval: 60,
            //minTime: '10',
            //maxTime: '6:00pm',
            //defaultTime: '11',
            startTime: '08:00',
            dynamic: false,
            dropdown: true,
            scrollbar: true,
            change: function () {
                debugger;
                var id = $(this).attr("id");
                var val = $(this).val();
                setInitialPunchTime(id, val);
            }
        });
        $("#btnSavePunches").click(function () {
            debugger;
            var isRequiredValidated = 0;
            var isValidated = true;
            var message = "";
            var dataObj = new Object();
            dataObj.ReferenceIds = '@selectedTSDIds';
            dataObj.PunchCount =$("#PunchCount").val();
            dataObj.PunchIn1 = $('#PunchIn1').val();
            dataObj.PunchOut1 = $('#PunchOut1').val();
            dataObj.PunchIn2 =$('#PunchIn2').val();           
            dataObj.PunchOut2 =$('#PunchOut2').val();
            dataObj.PunchIn1Overnight=$('#PunchIn1Overnight').is(":checked");           
            dataObj.PunchOut1Overnight =$('#PunchOut1Overnight').is(":checked");
            dataObj.PunchIn2Overnight =$('#PunchIn2Overnight').is(":checked");
            dataObj.PunchOut2Overnight =$('#PunchOut2Overnight').is(":checked");
            dataObj.Note =$('#PunchNote').val();
            
            isRequiredValidated += dataObj.PunchIn1.trim().length > 0 ? 1 : 0;
            isRequiredValidated += dataObj.PunchOut1.trim().length > 0 ? 1 : 0;
            isRequiredValidated += dataObj.PunchIn2.trim().length > 0 ? 1 : 0;
            isRequiredValidated += dataObj.PunchOut2.trim().length > 0 ? 1 : 0;
            if (dataObj.PunchCount=="1" && isRequiredValidated < 1) {
                isValidated = false;
                message = "Missing required Punch data.";
            }
            else if (dataObj.PunchCount == "2" && isRequiredValidated < 2) {
                isValidated = false;
                message = "Missing required Punch data";
            }
            else if (dataObj.PunchCount == "4" && isRequiredValidated < 4) {
                isValidated = false;
                message = "Missing required Punch data";
            }
            if (!isValidated) {
                showAlertAutoHide("", "Error", message);
                return;
            }

            $.ajax({
                type: "POST",
                url: '/EmployeeTimesheetEditor/AjaxValidatePunches',
                data: JSON.stringify(dataObj),
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    debugger;
                    //showAlertAutoHide("", data.status, data.message);
                    //$("#PunchInOut1Hrs").val(data.inOut1Hrs);
                    //$("#PunchInOut2Hrs").val(data.inOut2Hrs);
                    if (data.status == "Success") {
                        savePunchesData(dataObj,'@openType')
                    }
                    else {
                        showAlertAutoHide("", data.status, data.message);
                    }
                },
                error: function () {
                }
            });
        });

    });


    function setFieldLayout(punchCount) {
        debugger;
        switch (punchCount) {
            case "1":
                $(".divPunchIn1ONight").removeClass("hideField").addClass("showField");
                $(".divPunchOut1").removeClass("showField").addClass("hideField");
                $(".divPunchInOut2").removeClass("showField").addClass("hideField");
                break;
            case "2":
                $(".divPunchIn1ONight").removeClass("showField").addClass("hideField");
                $(".divPunchOut1").removeClass("hideField").addClass("showField");
                $(".divPunchInOut2").removeClass("showField").addClass("hideField");
                break;
            case "4":
                $(".divPunchIn1ONight").removeClass("showField").addClass("hideField");
                $(".divPunchOut1").removeClass("hideField").addClass("showField");
                $(".divPunchInOut2").removeClass("hideField").addClass("showField");
                break;
        }
       
    }
    function resetFields() {
        $("#PunchIn1").val("");
        $("#PunchOut1").val("");
        $("#PunchIn2").val("");
        $("#PunchOut2").val("");
        $("#PunchIn1Overnight").prop("checked", false);
        $("#PunchOut1Overnight").prop("checked", false);
        $("#PunchIn2Overnight").prop("checked", false);
        $("#PunchOut2Overnight").prop("checked", false);
        $("#PunchInOut1Hrs").val("");
        $("#PunchInOut2Hrs").val("");
    }
    function setEnDisableOvernight(id, isChecked) {
        var punchCount = $("#PunchCount").val();
        if (punchCount == 4) {
            if (id == "PunchOut1Overnight" && isChecked == true) {
                $("#PunchIn2Overnight").prop("checked", isChecked);
                $("#PunchOut2Overnight").prop("checked", isChecked);
                $("#PunchIn2Overnight").prop("disabled", isChecked);
                $("#PunchOut2Overnight").prop("disabled", isChecked);
            }
            else if (id == "PunchOut1Overnight" && isChecked == false) {
                $("#PunchIn2Overnight").prop("checked", isChecked);
                $("#PunchOut2Overnight").prop("checked", isChecked);
                $("#PunchIn2Overnight").prop("disabled", isChecked);
                $("#PunchOut2Overnight").prop("disabled", isChecked);
            }
            else if (id == "PunchIn2Overnight" && isChecked == true) {
                $("#PunchOut2Overnight").prop("checked", isChecked);
                $("#PunchOut2Overnight").prop("disabled", isChecked);
            }
            else if (id == "PunchIn2Overnight" && isChecked == false) {
                $("#PunchOut2Overnight").prop("checked", isChecked);
                $("#PunchOut2Overnight").prop("disabled", isChecked);
            }
        }

    }
    function setInitialPunchTime(id, val) {
        switch (id) {
            case 'PunchIn1':
                $("#PunchOut1").val(val);
                $("#PunchIn2").val(val);
                $("#PunchOut2").val(val);
                break;
            case 'PunchOut1':
                $("#PunchIn2").val(val);
                $("#PunchOut2").val(val);
                break;
            case 'PunchIn2':
                $("#PunchOut2").val(val);
                break;          

        }
        computePunchesTime();
    }
    function computePunchesTime() {
        var dataObj = new Object();
        dataObj.PunchCount = $("#PunchCount").val();
        dataObj.PunchIn1 = $('#PunchIn1').val();
        dataObj.PunchOut1 = $('#PunchOut1').val();
        dataObj.PunchIn2 = $('#PunchIn2').val();
        dataObj.PunchOut2 = $('#PunchOut2').val();
        dataObj.PunchIn1Overnight = $('#PunchIn1Overnight').is(":checked");
        dataObj.PunchOut1Overnight = $('#PunchOut1Overnight').is(":checked");
        dataObj.PunchIn2Overnight = $('#PunchIn2Overnight').is(":checked");
        dataObj.PunchOut2Overnight = $('#PunchOut2Overnight').is(":checked");
        $.ajax({
            type: "POST",
            url: '/EmployeeTimesheetEditor/AjaxComputePunchesTime',
            data: JSON.stringify(dataObj),
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                debugger;
                //showAlertAutoHide("", data.status, data.message);
                $("#PunchInOut1Hrs").val(data.inOut1Hrs);
                $("#PunchInOut2Hrs").val(data.inOut2Hrs);

                if (data.inOut1Hrs < 0)
                    $("#PunchInOut1Hrs").addClass("text-danger");
                else
                    $("#PunchInOut1Hrs").removeClass("text-danger");

                if (data.inOut2Hrs < 0)
                    $("#PunchInOut2Hrs").addClass("text-danger");
                else
                    $("#PunchInOut2Hrs").removeClass("text-danger");

            },
            error: function () {
            }
        });
    }
</script>




